[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Vehicle",
  "enabled": 1,
  "modified": "2025-12-17 19:33:24.403685",
  "module": "Mhr",
  "name": "SET MANDATORY TO FALSE",
  "script": "frappe.ui.form.on('Vehicle', {\n\trefresh(frm) {\n\tfrm.toggle_reqd('model', false);\n\tfrm.toggle_reqd('license_plate', false);\n\tfrm.toggle_reqd('make', false);\n\tfrm.toggle_reqd('last_odometer', false);\n\tfrm.toggle_reqd('fuel_type', false);\n\tfrm.toggle_reqd('uom', false);\n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Container",
  "enabled": 0,
  "modified": "2025-12-17 19:33:24.485315",
  "module": "Mhr",
  "name": "Container",
  "script": "frappe.ui.form.on(\"Container\", {\n    refresh(frm) {\n        console.log(\"Container form refreshed.\");\n    }\n});\n\nfrappe.ui.form.on(\"Batches\", \"qty\", function(frm, cdt, cdn) {\n    console.log(\"Batches qty field changed.\");\n    var d = locals[cdt][cdn];\n    console.log(\"Current row data:\", d);\n    var total = 0;\n    \n    // Ensure frm.doc.batches exists and is an array\n    if (frm.doc.batches && Array.isArray(frm.doc.batches)) {\n        frm.doc.batches.forEach(function(batch) {\n            total += batch.qty || 0; // Add a default value of 0 to handle undefined\n        });\n    } else {\n        console.log(\"frm.doc.batches is not defined or not an array\");\n    }\n\n    console.log(\"Total quantity:\", total);\n    frm.set_value(\"total_batches\", total);\n    refresh_field(\"total_batches\");\n});\n\n\nfrappe.ui.form.on('Batch Items', {\n\trefresh(frm) {\n\t\t// your code here\n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Batch",
  "enabled": 1,
  "modified": "2025-12-17 19:33:24.456047",
  "module": "Mhr",
  "name": "Batch",
  "script": "frappe.listview_settings['Batch'] = {\n    onload: function(listview) {\n        listview.page.add_inner_button(__('Print'), function() {\n            let selected_docs = listview.get_checked_items();\n            if (selected_docs.length > 0) {\n                let docnames = selected_docs.map(doc => doc.name);\n                call_print_selected_docs(docnames);\n            } else {\n                frappe.msgprint(__('Please select at least one document to print.'));\n            }\n        });\n    }\n};\n\nfunction call_print_selected_docs(docnames) {\n    // Construct the dictionary format expected by the backend\n    let doctype_dict = {\n        \"Sales Invoice\": docnames\n    };\n\n    frappe.call({\n        method: 'mhr.utilis.generate_multi_pdf_url',\n        args: {\n            doctype: doctype_dict,\n        },\n        callback: function(r) {\n            console.log(r.message);\n            if (r.message) {\n                var pdf_url = r.message;\n                var w = window.open(pdf_url);\n                if (!w) {\n                    frappe.msgprint(__('Please enable pop-ups'));\n                    return;\n                }\n            }\n        }\n    });\n}\n",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Delivery Note",
  "enabled": 1,
  "modified": "2025-12-17 19:33:23.907068",
  "module": "Mhr",
  "name": "Total",
  "script": "/*frappe.ui.form.on('Delivery Note', {\n    refresh: function(frm) {\n        // Only calculate if document is draft\n        if (frm.doc.docstatus === 0) {\n            calculate_total_cone(frm);\n        }\n    }\n});\n\nfrappe.ui.form.on('Delivery Note Item', {\n    items_add: function(frm, cdt, cdn) {\n        if (frm.doc.docstatus === 0) {\n            calculate_total_cone(frm);\n        }\n    },\n    items_remove: function(frm, cdt, cdn) {\n        if (frm.doc.docstatus === 0) {\n            calculate_total_cone(frm);\n        }\n    },\n    custom_cone: function(frm, cdt, cdn) {\n        if (frm.doc.docstatus === 0) {\n            calculate_total_cone(frm);\n        }\n    }\n});\n\n// Function to calculate total cone\nfunction calculate_total_cone(frm) {\n    let total_cone = 0;\n\n    (frm.doc.items || []).forEach(function(row) {\n        total_cone += parseFloat(row.custom_cone || 0);\n    });\n\n    frm.set_value('custom_total_cone', total_cone);\n    frm.refresh_field('custom_total_cone');\n}\n*/\nfrappe.ui.form.on('Delivery Note', {\n    refresh: function(frm) {\n        // Only calculate if document is draft\n        if (frm.doc.docstatus === 0) {\n            calculate_total_cone(frm);\n        }\n    }\n});\n\nfrappe.ui.form.on('Delivery Note Item', {\n    items_add: function(frm, cdt, cdn) {\n        if (frm.doc.docstatus === 0) {\n            calculate_total_cone(frm);\n        }\n    },\n    items_remove: function(frm, cdt, cdn) {\n        if (frm.doc.docstatus === 0) {\n            calculate_total_cone(frm);\n        }\n    },\n    custom_cone: function(frm, cdt, cdn) {\n        if (frm.doc.docstatus === 0) {\n            calculate_total_cone(frm);\n        }\n    }\n});\n\n// Function to calculate total cone safely\nfunction calculate_total_cone(frm) {\n    let total_cone = 0;\n\n    (frm.doc.items || []).forEach(function(row) {\n        total_cone += parseFloat(row.custom_cone || 0);\n    });\n\n    // Round to 2 decimals to avoid floating point issues\n    total_cone = parseFloat(total_cone.toFixed(2));\n\n    // Only update if value really changed\n    if (parseFloat(frm.doc.custom_total_cone || 0) !== total_cone) {\n        frm.set_value('custom_total_cone', total_cone);\n        // No need to call refresh_field, set_value handles it\n    }\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Delivery Note",
  "enabled": 1,
  "modified": "2025-12-17 19:33:24.133412",
  "module": "Mhr",
  "name": "Send multiple email",
  "script": "frappe.listview_settings['Delivery Note'] = frappe.listview_settings['Delivery Note'] || {};\n\nfrappe.listview_settings['Delivery Note'] = {\n  ...frappe.listview_settings['Delivery Note'],\n  onload: function (listview) {\n    // Add custom button to the list view\n    listview.page.add_action_item(__('Send Email'), function () {\n      const selected_docs = listview.get_checked_items();\n\n      if (selected_docs.length === 0) {\n        frappe.msgprint(__('Please select at least one Delivery Note'));\n        return;\n      }\n\n      // Use the first document to fetch full data\n      const first_doc = selected_docs[0].name;\n      const all_docs = selected_docs.map(doc => doc.name);\n\n      frappe.call({\n        method: \"frappe.client.get\",\n        args: {\n          doctype: \"Delivery Note\",\n          name: first_doc\n        },\n        callback: function (r) {\n          if (!r.exc) {\n            const doc = r.message;\n\n            // Get default print format\n            const print_format = frappe.get_meta(\"Delivery Note\").default_print_format || \"Standard\";\n\n            // Prepare attachments for all selected delivery notes\n            const attachments = all_docs.map(dn_name => ({\n              print_format: print_format,\n              doctype: \"Delivery Note\",\n              name: dn_name\n            }));\n\n            // Generate subject line\n            let subject = \"\";\n            if (all_docs.length === 1) {\n              subject = `Delivery Note: ${all_docs[0]}`;\n            } else {\n              subject = `Delivery Notes: ${all_docs[0]} and ${all_docs.length - 1} more`;\n            }\n\n            // Open the standard email dialog\n            new frappe.views.CommunicationComposer({\n              doc: doc,\n              subject: subject,\n              recipients: doc.contact_email || \"\",\n              attach_document_print: false, // We'll handle attachments manually\n              attachments: [\"http://localhost:89/files/1386.pdf\"],\n              sender: frappe.user.name,\n              sender_full_name: frappe.user.full_name,\n              frm: null // Since we're in list view\n            });\n          }\n        }\n      });\n    });\n  }\n};\n",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Delivery Note",
  "enabled": 1,
  "modified": "2025-12-17 19:33:23.956161",
  "module": "Mhr",
  "name": "Create Delivery Trip",
  "script": "/*// Store the original settings before modification\nconst originalListViewSettings = frappe.listview_settings['Delivery Note'] || {};\n\n// Create a new object with the original settings\nfrappe.listview_settings['Delivery Note'] = {\n    ...originalListViewSettings,\n    \n    // Override onload while preserving the original functionality\n    onload: function(listview) {\n        // Call the original onload function if it exists\n        if (originalListViewSettings.onload) {\n            originalListViewSettings.onload(listview);\n        }\n        \n        // Add custom button for creating delivery trip\n        listview.page.add_action_item(__('Create Delivery Trip'), function() {\n            const selected_docs = listview.get_checked_items();\n            \n            if (selected_docs.length === 0) {\n                frappe.msgprint(__('Please select at least one Delivery Note'));\n                return;\n            }\n            \n            // Get the names of all selected delivery notes\n            const delivery_note_names = selected_docs.map(doc => doc.name);\n            \n            // Fetch complete details of all selected delivery notes\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Delivery Note',\n                    fields: ['name', 'customer', 'customer_address', 'contact_person', \n                            'shipping_address_name', 'company', 'grand_total'],\n                    filters: { name: ['in', delivery_note_names] }\n                },\n                callback: function(r) {\n                    if (r.exc) {\n                        frappe.msgprint(__('Error fetching delivery notes'));\n                        return;\n                    }\n                    \n                    if (!r.message || !r.message.length) {\n                        frappe.msgprint(__('No valid Delivery Notes found'));\n                        return;\n                    }\n                    \n                    const delivery_notes = r.message;\n                    const companies = new Set(delivery_notes.map(dn => dn.company));\n                    \n                    // Validate that all delivery notes belong to the same company\n                    if (companies.size > 1) {\n                        frappe.msgprint(__('Selected Delivery Notes must belong to the same company'));\n                        return;\n                    }\n                    \n                    // Create a new delivery trip\n                    frappe.model.with_doctype('Delivery Trip', function() {\n                        const delivery_trip = frappe.model.get_new_doc('Delivery Trip');\n                        \n                        // Set basic delivery trip details\n                        delivery_trip.company = delivery_notes[0].company;\n                        delivery_trip.departure_time = frappe.datetime.now_datetime();\n                        \n                        // Add delivery stops for each delivery note\n                        delivery_notes.forEach(function(dn) {\n                            const child = frappe.model.add_child(delivery_trip, 'Delivery Stop', 'delivery_stops');\n                            child.delivery_note = dn.name;\n                            child.customer = dn.customer;\n                            child.address = dn.shipping_address_name || dn.customer_address;\n                            child.contact = dn.contact_person;\n                            child.grand_total = dn.grand_total;\n                            child.estimated_arrival = frappe.datetime.now_datetime();\n                        });\n                        \n                        // Open the new delivery trip form\n                        frappe.set_route('Form', 'Delivery Trip', delivery_trip.name);\n                    });\n                }\n            });\n        });\n        \n        // Add custom button for sending email (preserve the existing functionality)\n        // Only add if it's not already added by the original settings\n        if (!originalListViewSettings.hasOwnProperty('sendEmailAdded')) {\n            listview.page.add_action_item(__('Send Email'), function() {\n                const selected_docs = listview.get_checked_items();\n                \n                if (selected_docs.length === 0) {\n                    frappe.msgprint(__('Please select at least one Delivery Note'));\n                    return;\n                }\n                \n                // For multiple docs, use the first one to open the dialog but attach all\n                const first_doc = selected_docs[0].name;\n                const all_docs = selected_docs.map(doc => doc.name);\n                \n                // Open the email dialog directly instead of using a custom function\n                frappe.call({\n                    method: \"frappe.client.get\",\n                    args: {\n                        doctype: \"Delivery Note\",\n                        name: first_doc\n                    },\n                    callback: function(r) {\n                        if (!r.exc) {\n                            const doc = r.message;\n                            \n                            // Get default print format\n                            const print_format = frappe.get_meta(\"Delivery Note\").default_print_format || \"Standard\";\n                            \n                            // Prepare attachments for all selected delivery notes\n                            const attachments = all_docs.map(dn_name => {\n                                return {\n                                    \"print_format\": print_format,\n                                    \"doctype\": \"Delivery Note\",\n                                    \"name\": dn_name\n                                };\n                            });\n                            \n                            // Generate subject line\n                            let subject = \"\";\n                            if (all_docs.length === 1) {\n                                subject = `Delivery Note: ${all_docs[0]}`;\n                            } else {\n                                subject = `Delivery Notes: ${all_docs[0]} and ${all_docs.length - 1} more`;\n                            }\n                            \n                            // Open the standard email dialog\n                            new frappe.views.CommunicationComposer({\n                                doc: doc,\n                                subject: subject,\n                                recipients: doc.contact_email || \"\",\n                                attach_document_print: false, // We'll handle attachments manually\n                                attachments: attachments,\n                                sender: frappe.user.name,\n                                sender_full_name: frappe.user.full_name,\n                                frm: null // since we're in list view\n                            });\n                        }\n                    }\n                });\n            });\n        }\n    }\n};\n\n// Flag to prevent duplicate buttons\nfrappe.listview_settings['Delivery Note'].sendEmailAdded = true;*/\n\n\n\n// Store the original settings before modification\nconst originalListViewSettings = frappe.listview_settings['Delivery Note'] || {};\n\n// Create a new object with the original settings\nfrappe.listview_settings['Delivery Note'] = {\n    ...originalListViewSettings,\n\n    onload: function (listview) {\n        // Call original onload if it exists\n        if (originalListViewSettings.onload) {\n            originalListViewSettings.onload(listview);\n        }\n\n        // --- \"Create Delivery Trip\" button ---\n        listview.page.add_action_item(__('Create Delivery Trip'), function () {\n            const selected_docs = listview.get_checked_items();\n            if (selected_docs.length === 0) {\n                frappe.msgprint(__('Please select at least one Delivery Note'));\n                return;\n            }\n            const delivery_note_names = selected_docs.map(doc => doc.name);\n\n            frappe.call({\n                method: 'frappe.client.get_list',\n                args: {\n                    doctype: 'Delivery Note',\n                    fields: ['name', 'customer', 'customer_address', 'contact_person',\n                        'shipping_address_name', 'company', 'grand_total'],\n                    filters: { name: ['in', delivery_note_names] }\n                },\n                callback: function (r) {\n                    if (r.exc || !r.message || !r.message.length) {\n                        frappe.msgprint(__('No valid Delivery Notes found'));\n                        return;\n                    }\n                    const delivery_notes = r.message;\n                    const companies = new Set(delivery_notes.map(dn => dn.company));\n                    if (companies.size > 1) {\n                        frappe.msgprint(__('Selected Delivery Notes must belong to the same company'));\n                        return;\n                    }\n                    frappe.model.with_doctype('Delivery Trip', function () {\n                        const delivery_trip = frappe.model.get_new_doc('Delivery Trip');\n                        delivery_trip.company = delivery_notes[0].company;\n                        delivery_trip.departure_time = frappe.datetime.now_datetime();\n                        delivery_notes.forEach(function (dn) {\n                            const child = frappe.model.add_child(delivery_trip, 'Delivery Stop', 'delivery_stops');\n                            child.delivery_note = dn.name;\n                            child.customer = dn.customer;\n                            child.address = dn.shipping_address_name || dn.customer_address;\n                            child.contact = dn.contact_person;\n                            child.grand_total = dn.grand_total;\n                            child.estimated_arrival = frappe.datetime.now_datetime();\n                        });\n                        frappe.set_route('Form', 'Delivery Trip', delivery_trip.name);\n                    });\n                }\n            });\n        });\n\n        // --- \"Send Email\" button ---\n        \n    }\n};\n\n// Prevent duplicate Send Email button\nfrappe.listview_settings['Delivery Note'].sendEmailAdded = true;\n",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Delivery Trip",
  "enabled": 1,
  "modified": "2025-12-17 19:33:24.291300",
  "module": "Mhr",
  "name": "Delivery Trip Total Cone and Total Quantity Field",
  "script": "/*frappe.ui.form.on('Delivery Trip', {\n    // Trigger onload and when the delivery_stops table is modified\n    refresh: function(frm) {\n        calculate_totals(frm);\n    },\n    delivery_stops_on_form_rendered: function(frm) {\n        calculate_totals(frm);\n    }\n});\n\nfrappe.ui.form.on('Delivery Stop', {\n    custom_total_cones: function(frm, cdt, cdn) {\n        calculate_totals(frm);\n    },\n    custom_total_quantity: function(frm, cdt, cdn) {\n        calculate_totals(frm);\n    },\n    delivery_stops_remove: function(frm) {\n        calculate_totals(frm);\n    }\n});\n\nfunction calculate_totals(frm) {\n    let total_cones = 0;\n    let total_qty = 0;\n\n    (frm.doc.delivery_stops || []).forEach(function(row) {\n        total_cones += flt(row.custom_total_cones);\n        total_qty += flt(row.custom_total_quantity);\n    });\n\n    frm.set_value('custom_total_cones', total_cones);\n    frm.set_value('custom_total_quantity', total_qty);\n}\n*/\n/*\nfrappe.ui.form.on('Delivery Trip', {\n    onload_post_render: function(frm) {\n        calculate_totals_and_save_if_empty(frm);\n    },\n    delivery_stops_on_form_rendered: function(frm) {\n        calculate_totals_and_save_if_empty(frm);\n    }\n});\n\nfrappe.ui.form.on('Delivery Stop', {\n    custom_total_cones: function(frm, cdt, cdn) {\n        calculate_totals_and_save_if_empty(frm);\n    },\n    custom_total_quantity: function(frm, cdt, cdn) {\n        calculate_totals_and_save_if_empty(frm);\n    },\n    delivery_stops_remove: function(frm) {\n        calculate_totals_and_save_if_empty(frm);\n    }\n});\n\nfunction calculate_totals_and_save_if_empty(frm) {\n    const is_cones_empty = !flt(frm.doc.custom_total_cones);\n    const is_qty_empty = !flt(frm.doc.custom_total_quantity);\n\n    // Only proceed if at least one total field is empty\n    if (!(is_cones_empty || is_qty_empty)) {\n        return;\n    }\n\n    let total_cones = 0;\n    let total_qty = 0;\n\n    (frm.doc.delivery_stops || []).forEach(function(row) {\n        total_cones += flt(row.custom_total_cones);\n        total_qty += flt(row.custom_total_quantity);\n    });\n\n    let updated = false;\n\n    if (is_cones_empty) {\n        frm.set_value('custom_total_cones', total_cones);\n        updated = true;\n    }\n\n    if (is_qty_empty) {\n        frm.set_value('custom_total_quantity', total_qty);\n        updated = true;\n    }\n\n    if (updated) {\n        frappe.after_ajax(() => {\n            frm.save();\n        });\n    }\n}\n*/\n\nfrappe.ui.form.on('Delivery Trip', {\n    onload_post_render: function(frm) {\n        calculate_totals_and_save_if_empty(frm);\n    },\n    delivery_stops_on_form_rendered: function(frm) {\n        calculate_totals_and_save_if_empty(frm);\n    }\n});\n\nfrappe.ui.form.on('Delivery Stop', {\n    custom_total_cones: function(frm, cdt, cdn) {\n        calculate_totals_and_save_if_empty(frm);\n    },\n    custom_total_quantity: function(frm, cdt, cdn) {\n        calculate_totals_and_save_if_empty(frm);\n    },\n    custom_item_length: function(frm, cdt, cdn) {\n        calculate_totals_and_save_if_empty(frm);\n    },\n    delivery_stops_remove: function(frm) {\n        calculate_totals_and_save_if_empty(frm);\n    }\n});\n\nfunction calculate_totals_and_save_if_empty(frm) {\n    const is_cones_empty = !flt(frm.doc.custom_total_cones);\n    const is_qty_empty = !flt(frm.doc.custom_total_quantity);\n    const is_length_empty = !flt(frm.doc.custom_total_item_length);\n\n    // Only proceed if at least one total field is empty\n    if (!(is_cones_empty || is_qty_empty || is_length_empty)) {\n        return;\n    }\n\n    let total_cones = 0;\n    let total_qty = 0;\n    let total_length = 0;\n\n    (frm.doc.delivery_stops || []).forEach(function(row) {\n        total_cones += flt(row.custom_total_cones);\n        total_qty += flt(row.custom_total_quantity);\n        total_length += flt(row.custom_item_length);\n    });\n\n    let updated = false;\n\n    if (is_cones_empty) {\n        frm.set_value('custom_total_cones', total_cones);\n        updated = true;\n    }\n\n    if (is_qty_empty) {\n        frm.set_value('custom_total_quantity', total_qty);\n        updated = true;\n    }\n\n    if (is_length_empty) {\n        frm.set_value('custom_total_item_length', total_length);\n        updated = true;\n    }\n\n    if (updated) {\n        frappe.after_ajax(() => {\n            frm.save();\n        });\n    }\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Delivery Note",
  "enabled": 0,
  "modified": "2025-12-17 19:33:23.556159",
  "module": "Mhr",
  "name": "Fetching details on container no from batch to delivery note",
  "script": "/*frappe.ui.form.on('Delivery Note', {\n    custom_container_no: function(frm) {\n        if (frm.doc.custom_container_no) {\n            frappe.db.get_list('Batch', {\n                filters: {\n                    custom_container_no: frm.doc.custom_container_no\n                },\n                limit: 1\n            }).then(result => {\n                if (result && result.length > 0) {\n                    const batch_name = result[0].name;\n                    frappe.db.get_doc('Batch', batch_name).then(batch => {\n                        frm.set_value('custom_glue', batch.custom_glue || '');\n                        frm.set_value('custom_pulp', batch.custom_pulp || '');\n                        frm.set_value('custom_lusture', batch.custom_lusture || '');\n                        frm.set_value('custom_grade', batch.custom_grade || '');\n                        frm.set_value('custom_lot_no', batch.custom_lot_no || '');\n                        frm.set_value('custom_fsc', batch.custom_fsc || '');\n                        frm.set_value('custom_denier', batch.item || '');\n                    });\n                } else {\n                    frappe.msgprint(__('No Batch found with Container No: ') + frm.doc.custom_container_no);\n                    clear_batch_fields(frm);\n                }\n            });\n        } else {\n            clear_batch_fields(frm);\n        }\n    }\n});\n\nfunction clear_batch_fields(frm) {\n    const fields = [\n        'custom_glue',\n        'custom_pulp',\n        'custom_lusture',\n        'custom_grade',\n        'custom_lot_no',\n        'custom_fsc',\n        'custom_denier'\n    ];\n    fields.forEach(field => frm.set_value(field, ''));\n}*/\nasync function get_all_batches(container_no) {\n    let all_batches = [];\n    let page = 0;\n    const page_size = 50;\n\n    while (true) {\n        let response = await frappe.call({\n            method: 'frappe.client.get_list',\n            args: {\n                doctype: 'Batch',\n                filters: { custom_container_no: container_no },\n                fields: [\n                    'name',\n                    'custom_glue',\n                    'custom_pulp',\n                    'custom_lusture',\n                    'custom_grade',\n                    'custom_lot_no',\n                    'custom_fsc',\n                    'custom_cone',\n                    'item'\n                ],\n                limit_page_length: page_size,\n                limit_start: page * page_size,\n                order_by: 'name asc'\n            }\n        });\n\n        let batches = response.message || [];\n\n        if (batches.length === 0) break;\n\n        all_batches = all_batches.concat(batches);\n\n        if (batches.length < page_size) break;\n\n        page++;\n    }\n\n    return all_batches;\n}\n\nfrappe.ui.form.on('Delivery Note', {\n    async custom_container_no(frm) {\n        if (frm.doc.custom_container_no) {\n            let batches = await get_all_batches(frm.doc.custom_container_no);\n\n            if (batches.length === 0) {\n                frappe.msgprint(__('No Batch found with Container No: {0}', [frm.doc.custom_container_no]));\n                clear_batch_fields(frm);\n                return;\n            }\n\n            let rows_html = batches.map(batch => `\n                <tr>\n                    <td style=\"text-align:center;\">\n                        <input type=\"radio\" name=\"batch_select\" value=\"${batch.name}\">\n                    </td>\n                    <td>${batch.custom_lot_no || '-'}</td>\n                    <td>${batch.custom_cone || '-'}</td>\n                </tr>\n            `).join('');\n\n            let dialog_content = `\n                <div style=\"max-height: 300px; overflow-y: auto;\">\n                    <table class=\"table table-bordered table-striped\" style=\"width:100%; margin-bottom:0;\">\n                        <thead>\n                            <tr>\n                                <th style=\"width:50px; text-align:center;\">Select</th>\n                                <th>Lot No</th>\n                                <th>Cone</th>\n                            </tr>\n                        </thead>\n                        <tbody>\n                            ${rows_html}\n                        </tbody>\n                    </table>\n                </div>\n            `;\n\n            let d = new frappe.ui.Dialog({\n                title: __('Select Batch'),\n                fields: [\n                    {\n                        fieldtype: 'HTML',\n                        fieldname: 'batch_list',\n                        options: dialog_content\n                    }\n                ],\n                primary_action_label: __('Select'),\n                primary_action: function() {\n                    let selected_batch_name = d.wrapper.find('input[name=\"batch_select\"]:checked').val();\n\n                    if (!selected_batch_name) {\n                        frappe.msgprint(__('Please select a batch'));\n                        return;\n                    }\n\n                    frappe.db.get_doc('Batch', selected_batch_name).then(batch => {\n                        frm.set_value('custom_glue', batch.custom_glue || '');\n                        frm.set_value('custom_pulp', batch.custom_pulp || '');\n                        frm.set_value('custom_lusture', batch.custom_lusture || '');\n                        frm.set_value('custom_grade', batch.custom_grade || '');\n                        frm.set_value('custom_lot_no', batch.custom_lot_no || '');\n                        frm.set_value('custom_fsc', batch.custom_fsc || '');\n                        frm.set_value('custom_cone', batch.custom_cone || '');\n                        frm.set_value('custom_denier', batch.item || '');\n\n                        d.hide();\n                    });\n                }\n            });\n\n            d.show();\n\n        } else {\n            clear_batch_fields(frm);\n        }\n    }\n});\n\nfunction clear_batch_fields(frm) {\n    const fields = [\n        'custom_glue',\n        'custom_pulp',\n        'custom_lusture',\n        'custom_grade',\n        'custom_lot_no',\n        'custom_fsc',\n        'custom_denier',\n        'custom_cone'\n    ];\n    fields.forEach(field => frm.set_value(field, ''));\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Delivery Note",
  "enabled": 1,
  "modified": "2025-12-17 19:33:24.164835",
  "module": "Mhr",
  "name": "Setting to and cc in delivery note +New Email Button",
  "script": "/*frappe.ui.form.on('Delivery Note', {\n    refresh: function(frm) {\n        // Disconnect old observer if present\n        if (frm.__email_modal_observer) {\n            frm.__email_modal_observer.disconnect();\n        }\n\n        const observer = new MutationObserver(() => {\n            const modalTitle = document.querySelector('.modal-dialog .modal-title');\n            if (modalTitle && modalTitle.textContent.trim() === 'New Email') {\n                // Set Subject\n                const subjectInput = document.querySelector('input[data-fieldname=\"subject\"]');\n                if (subjectInput) {\n                    subjectInput.value = 'SMP - Delivery Note';\n                    subjectInput.dispatchEvent(new Event('input', { bubbles: true }));\n                }\n\n                // Set Recipients\n                const toInput = document.querySelector('input[data-fieldname=\"recipients\"]');\n                if (toInput) {\n                    toInput.value = 'billing@meherinternational.in';\n                    toInput.dispatchEvent(new Event('input', { bubbles: true }));\n                }\n\n                // Set CC\n                const ccInput = document.querySelector('input[data-fieldname=\"cc\"]');\n                if (ccInput) {\n                    ccInput.value = 'viscose@meherinternational.in, haresh@meherinternational.in, warehouse2@meherinternational.in';\n                    ccInput.dispatchEvent(new Event('input', { bubbles: true }));\n                }\n\n                // Done, disconnect observer\n                frm.__email_modal_observer.disconnect();\n                frm.__email_modal_observer = null;\n            }\n        });\n\n        // Start watching for the email dialog\n        observer.observe(document.body, {\n            childList: true,\n            subtree: true\n        });\n\n        frm.__email_modal_observer = observer;\n    }\n});\n*/\n\nfrappe.ui.form.on('Delivery Note', {\n    refresh: function(frm) {\n        // Disconnect old observer if present\n        if (frm.__email_modal_observer) {\n            frm.__email_modal_observer.disconnect();\n        }\n\n        const observer = new MutationObserver(() => {\n            const modalTitle = document.querySelector('.modal-dialog .modal-title');\n            if (modalTitle && modalTitle.textContent.trim() === 'New Email') {\n                // Set Recipients\n                const toInput = document.querySelector('input[data-fieldname=\"recipients\"]');\n                if (toInput) {\n                    toInput.value = 'billing@meherinternational.in';\n                    toInput.dispatchEvent(new Event('input', { bubbles: true }));\n                }\n\n                // Set CC\n                const ccInput = document.querySelector('input[data-fieldname=\"cc\"]');\n                if (ccInput) {\n                    ccInput.value = 'viscose@meherinternational.in, haresh@meherinternational.in, warehouse2@meherinternational.in';\n                    ccInput.dispatchEvent(new Event('input', { bubbles: true }));\n                }\n\n                // Done, disconnect observer\n                frm.__email_modal_observer.disconnect();\n                frm.__email_modal_observer = null;\n            }\n        });\n\n        // Start watching for the email dialog\n        observer.observe(document.body, {\n            childList: true,\n            subtree: true\n        });\n\n        frm.__email_modal_observer = observer;\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Delivery Note",
  "enabled": 1,
  "modified": "2025-12-17 19:33:24.195638",
  "module": "Mhr",
  "name": "Send Email",
  "script": "/*frappe.ui.form.on('Delivery Note', {\n    refresh: function(frm) {\n        frm.add_custom_button(__('Send WhatsApp'), function() {\n            frappe.prompt(\n                {\n                    fieldname: 'phone',\n                    label: 'Enter WhatsApp Number',\n                    fieldtype: 'Data',\n                    reqd: 1,\n                    description: 'Use format like 919999999999 (No + or spaces)'\n                },\n                function(values) {\n                    const phone = values.phone;\n\n                    const base_url = window.location.origin;\n                    const file_url = `/api/method/mhr.print.preview?name=${frm.doc.name}`;\n\n                    const message = encodeURIComponent(\n                        `Hello,\\nPlease find the Delivery Note for ${frm.doc.name} below:\\n${base_url}${file_url}`\n                    );\n\n                    const whatsapp_url = `https://wa.me/${phone}?text=${message}`;\n\n                    window.open(whatsapp_url, '_blank');\n                },\n                'Send WhatsApp Message',\n                'Send'\n            );\n        });\n    }\n});\n*/\n\nfrappe.ui.form.on('Delivery Note', {\n    refresh: function(frm) {\n        frm.add_custom_button(__('Send WhatsApp'), function() {\n            frappe.prompt(\n                {\n                    fieldname: 'phone',\n                    label: 'Enter WhatsApp Number',\n                    fieldtype: 'Data',\n                    reqd: 1,\n                    default: '917801988820',\n                    description: 'Use format like 919999999999 (No + or spaces)'\n                },\n                function(values) {\n                    const phone = values.phone;\n                    const base_url = window.location.origin;\n                    const file_url = `/api/method/mhr.print.preview?name=${frm.doc.name}`;\n                    const company = frm.doc.company || 'your company';\n\n                    const message = encodeURIComponent(\n                        `Hello,\\nPlease find the Delivery Note for ${frm.doc.name} from ${company} below:\\n${base_url}${file_url}`\n                    );\n\n                    const whatsapp_url = `https://wa.me/${phone}?text=${message}`;\n\n                    window.open(whatsapp_url, '_blank');\n                },\n                'Send WhatsApp Message',\n                'Send'\n            );\n        });\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Delivery Note",
  "enabled": 1,
  "modified": "2025-12-17 19:33:23.977693",
  "module": "Mhr",
  "name": "Setting to and cc as default in list view",
  "script": "/*// Monkey-patch only once to avoid breaking other dialogs\nif (!frappe.__custom_email_patch_applied) {\n    const OriginalComposer = frappe.views.CommunicationComposer;\n\n    frappe.views.CommunicationComposer = class CustomComposer extends OriginalComposer {\n        make() {\n            super.make();\n\n            // Apply default recipients only for Delivery Note in List View\n            const route = frappe.get_route();\n            const is_delivery_note_list =\n                route[0] === \"List\" && route[1] === \"Delivery Note\";\n\n            if (is_delivery_note_list && this.dialog && this.dialog.fields_dict) {\n                const recipientsField = this.dialog.fields_dict.recipients;\n                const ccField = this.dialog.fields_dict.cc;\n                const subjectField = this.dialog.fields_dict.subject; // ✅ Get subject field\n\n                // Slight delay to ensure fields are ready\n                setTimeout(() => {\n                    if (recipientsField && recipientsField.set_value) {\n                        recipientsField.set_value(\"billing@meherinternational.in\");\n                    }\n                    if (ccField && ccField.set_value) {\n                        ccField.set_value(\"viscose@meherinternational.in, haresh@meherinternational.in, warehouse2@meherinternational.in\");\n                    }\n                    if (subjectField && subjectField.set_value) { // ✅ Set subject\n                        subjectField.set_value(\"SMP - Delivery Note\");\n                    }\n                }, 300);\n            }\n        }\n    };\n\n    frappe.__custom_email_patch_applied = true;\n}*/\n\n// Monkey-patch only once to avoid breaking other dialogs\nif (!frappe.__custom_email_patch_applied) {\n    const OriginalComposer = frappe.views.CommunicationComposer;\n\n    frappe.views.CommunicationComposer = class CustomComposer extends OriginalComposer {\n        make() {\n            super.make();\n\n            // Apply default recipients only for Delivery Note in List View\n            const route = frappe.get_route();\n            const is_delivery_note_list =\n                route[0] === \"List\" && route[1] === \"Delivery Note\";\n\n            if (is_delivery_note_list && this.dialog && this.dialog.fields_dict) {\n                const recipientsField = this.dialog.fields_dict.recipients;\n                const ccField = this.dialog.fields_dict.cc;\n                const subjectField = this.dialog.fields_dict.subject;\n\n                // Slight delay to ensure fields are ready\n                setTimeout(() => {\n                    // Get selected delivery note IDs from the list view\n                    const listView = frappe.container.page.list_view;\n                    const selectedDocs = listView && listView.get_checked_items ? listView.get_checked_items() : [];\n\n                    const deliveryNoteIDs = selectedDocs.map(doc => doc.name).join(\", \");\n\n                    if (recipientsField?.set_value) {\n                        recipientsField.set_value(\"billing@meherinternational.in\");\n                    }\n                    if (ccField?.set_value) {\n                        ccField.set_value(\"viscose@meherinternational.in, haresh@meherinternational.in, warehouse2@meherinternational.in\");\n                    }\n                    if (subjectField?.set_value) {\n                        const subject = deliveryNoteIDs ? `Delivery Notes: ${deliveryNoteIDs}` : \"Delivery Notes\";\n                        subjectField.set_value(subject);\n                    }\n                }, 300);\n            }\n        }\n    };\n\n    frappe.__custom_email_patch_applied = true;\n}\n",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Delivery Trip",
  "enabled": 0,
  "modified": "2025-12-17 19:33:24.259796",
  "module": "Mhr",
  "name": "Delivery Trip Challan Number",
  "script": "frappe.ui.form.on('Delivery Trip', {\n    onload: function(frm) {\n        if (frm.is_new() && !frm.doc.challan_number) {\n            frappe.call({\n                method: \"server_script.get_next_challan_number\",\n                callback: function(r) {\n                    if (r.message) {\n                        frm.set_value('challan_number', r.message);\n                    }\n                }\n            });\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Delivery Note",
  "enabled": 1,
  "modified": "2025-12-17 19:33:23.933887",
  "module": "Mhr",
  "name": "Send Over Whatsapp in List View",
  "script": "frappe.listview_settings['Delivery Note'] = frappe.listview_settings['Delivery Note'] || {};\n\nfrappe.listview_settings['Delivery Note'].onload = function(listview) {\n    // Add \"Send WhatsApp\" button to the list view actions menu\n    listview.page.add_action_item(__('Send WhatsApp'), function() {\n        const selected_docs = listview.get_checked_items();\n\n        if (selected_docs.length === 0) {\n            frappe.msgprint(__('Please select at least one Delivery Note'));\n            return;\n        }\n\n        // Use only the first selected Delivery Note\n        const docname = selected_docs[0].name;\n        const base_url = window.location.origin;\n        const file_url = `/api/method/mhr.print.preview?name=${docname}`;\n\n        frappe.prompt(\n            {\n                fieldname: 'phone',\n                label: 'Enter WhatsApp Number',\n                fieldtype: 'Data',\n                reqd: 1,\n                default: '917801988820',\n                description: 'Use format like 919999999999 (No + or spaces)'\n            },\n            function(values) {\n                const phone = values.phone;\n                const message = encodeURIComponent(\n                    `Hello,\\nPlease find the Delivery Note for ${docname} below:\\n${base_url}${file_url}`\n                );\n                const whatsapp_url = `https://wa.me/${phone}?text=${message}`;\n                window.open(whatsapp_url, '_blank');\n            },\n            'Send WhatsApp Message',\n            'Send'\n        );\n    });\n};\n",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Delivery Note",
  "enabled": 1,
  "modified": "2025-12-17 19:33:24.100264",
  "module": "Mhr",
  "name": "Send Multiple Whatsapp",
  "script": "// Store the original settings before modification\nconst originalListViewSettings = frappe.listview_settings['Delivery Note'] || {};\n\n// Create a new object with the original settings\nfrappe.listview_settings['Delivery Note'] = {\n    ...originalListViewSettings,\n\n    onload: function (listview) {\n        // Call original onload if it exists\n        if (originalListViewSettings.onload) {\n            originalListViewSettings.onload(listview);\n        }\n\n        // --- \"Send WhatsApp\" button (multi-doc support) ---\n        listview.page.add_action_item(__('Send WhatsApp'), function () {\n            const selected_docs = listview.get_checked_items();\n            if (selected_docs.length === 0) {\n                frappe.msgprint(__('Please select at least one Delivery Note'));\n                return;\n            }\n            console.log( selected_docs.map(doc => doc.name)\n\n            // Get URLs for all selected delivery notes\n            frappe.call({\n                method: 'mhr.share.get_file_urls',\n                args: {\n                    delivery_notes: selected_docs.map(doc => doc.name)\n                },\n                callback: function(response) {\n                    if (response.message.success) {\n                        const messages = response.message.urls.map(item => {\n                            return `• ${item.delivery_note}: ${item.url}`;\n                        }).join('\\n');\n\n                        const full_message = encodeURIComponent(\n                            `Hello,\\nPlease find the Delivery Notes below:\\n${messages}`\n                        );\n\n                        frappe.prompt(\n                            {\n                                fieldname: 'phone',\n                                label: 'Enter WhatsApp Number',\n                                fieldtype: 'Data',\n                                reqd: 1,\n                                default: '917801988820',\n                                description: 'Use format like 919999999999 (No + or spaces)'\n                            },\n                            function (values) {\n                                const phone = values.phone;\n                                const whatsapp_url = `https://wa.me/${phone}?text=${full_message}`;\n                                window.open(whatsapp_url, '_blank');\n                            },\n                            'Send WhatsApp Message',\n                            'Send'\n                        );\n                    } else {\n                        frappe.msgprint(__('Error generating URLs: ') + response.message.error);\n                    }\n                }\n            });\n        });\n    }\n};\n\n// Prevent duplicate Send Email button\nfrappe.listview_settings['Delivery Note'].sendEmailAdded = true;\n",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Delivery Note",
  "enabled": 1,
  "modified": "2025-12-17 19:33:24.008047",
  "module": "Mhr",
  "name": "Hide ields",
  "script": "frappe.ui.form.on('Delivery Note', {\n    onload_post_render(frm) {\n        const grid = frm.fields_dict['items'].grid;\n\n        // Enable fields in list view\n        ['warehouse', 'amount'].forEach(fieldname => {\n            let df = grid.get_field(fieldname);\n            if (df) {\n                df.in_list_view = 1;\n            }\n        });\n\n        grid.refresh();\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Delivery Note",
  "enabled": 1,
  "modified": "2025-12-17 19:33:24.039583",
  "module": "Mhr",
  "name": "Challan Number Auto update",
  "script": "frappe.ui.form.on(\"Delivery Note\", {\r\n    onload(frm) {\r\n        if (frm.is_new() && frm.doc.naming_series) {\r\n            set_next_challan_no(frm);\r\n        }\r\n    },\r\n\r\n    naming_series(frm) {\r\n        if (frm.is_new()) {\r\n            set_next_challan_no(frm);\r\n        }\r\n    }\r\n});\r\n\r\nfunction set_next_challan_no(frm) {\r\n\r\n    const allowed_series = [\r\n        \"SMP-DN-.YYYY.-\",\r\n        \"MAT-DN-.YYYY.-\",\r\n        \"MAT-DN-RET-.YYYY.-\"\r\n    ];\r\n\r\n    if (!allowed_series.includes(frm.doc.naming_series)) {\r\n        return;\r\n    }\r\n\r\n    frappe.db.get_list(\"Delivery Note\", {\r\n        fields: [\"challan_number\"],\r\n        filters: {\r\n            naming_series: frm.doc.naming_series,\r\n            docstatus: 1\r\n        },\r\n        order_by: \"creation desc\",\r\n        limit: 1\r\n    }).then(records => {\r\n\r\n        let next_no = 1;   // ✅ default\r\n\r\n        if (records.length && records[0].challan_number) {\r\n            next_no = parseInt(records[0].challan_number) + 1;\r\n        }\r\n\r\n        // ✅ ✅ ✅ ALWAYS SET AS STRING (VERY IMPORTANT)\r\n        frm.set_value(\"challan_number\", String(next_no));\r\n    });\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Delivery Note",
  "enabled": 1,
  "modified": "2025-12-17 19:33:23.879415",
  "module": "Mhr",
  "name": "Cone Qty Calcuation",
  "script": " frappe.ui.form.on(\"Delivery Note\", {\n      onload_post_render(frm) {\n          console.log(\"=== onload_post_render fired ===\");\n          console.log(\"Naming series:\", frm.doc.naming_series);\n\n          let grid = frm.fields_dict[\"items\"].grid;\n          console.log(\"Grid object:\", grid);\n\n          // Avoid double binding\n          if (frm._cone_bound) {\n              console.log(\"Already bound, skipping\");\n              return;\n          }\n          frm._cone_bound = true;\n          console.log(\"Binding cone field events...\");\n\n          // 1) Capture previous value BEFORE edit (on focus)\n          grid.wrapper.on(\n              \"focus\",\n              \"input[data-fieldname='custom_cone']\",\n              function () {\n                  console.log(\"=== FOCUS EVENT on custom_cone ===\");\n\n                  let $input = $(this);\n                  let cdn = $input.closest(\".grid-row\").attr(\"data-name\");\n                  console.log(\"CDN:\", cdn);\n\n                  let row = locals[\"Delivery Note Item\"][cdn];\n                  if (!row) {\n                      console.log(\"Row not found!\");\n                      return;\n                  }\n                  console.log(\"Row data:\", row);\n\n                  // current input value at focus = the OLD value (before user types)\n                  let currentVal = $input.val();\n                  console.log(\"Current cone value on focus:\", currentVal);\n                  console.log(\"Existing custom_cone_copy:\", row.custom_cone_copy);\n\n                  // Only set copy if it's not already set and currentVal exists\n                  if ((!row.custom_cone_copy || row.custom_cone_copy === \"\") && currentVal !== undefined && currentVal !== \"\") {\n                      console.log(\"Setting custom_cone_copy to:\", currentVal);\n                      // Use frappe.model.set_value so change is persisted properly\n                      frappe.model.set_value(\"Delivery Note Item\", cdn, \"custom_cone_copy\", parseFloat(currentVal));\n                  }\n\n                  // store previous value on element too (optional, for extra safety)\n                  $input.data(\"prev-cone\", currentVal);\n                  console.log(\"Stored prev-cone data attribute:\", currentVal);\n              }\n          );\n\n          // 2) Handle change: fetch fresh qty from database and calculate\n          grid.wrapper.on(\n              \"change\",\n              \"input[data-fieldname='custom_cone']\",\n              function () {\n                  console.log(\"=== CHANGE EVENT on custom_cone ===\");\n\n                  let $input = $(this);\n                  let cdn = $input.closest(\".grid-row\").attr(\"data-name\");\n                  console.log(\"CDN:\", cdn);\n\n                  let row = locals[\"Delivery Note Item\"][cdn];\n                  if (!row) {\n                      console.log(\"Row not found!\");\n                      return;\n                  }\n                  console.log(\"Row data:\", row);\n                  console.log(\"New cone value:\", $input.val());\n                  console.log(\"custom_cone_copy:\", row.custom_cone_copy);\n\n                  // If custom_cone_copy somehow still not present, try to use stored prev data attribute\n                  if ((!row.custom_cone_copy || row.custom_cone_copy === \"\") && $input.data(\"prev-cone\") !== undefined) {\n                      let prev = $input.data(\"prev-cone\");\n                      console.log(\"custom_cone_copy missing, using prev-cone:\", prev);\n                      if (prev !== \"\" && prev !== undefined) {\n                          frappe.model.set_value(\"Delivery Note Item\", cdn, \"custom_cone_copy\", parseFloat(prev));\n                      }\n                  }\n\n                  // Fetch fresh qty from database and calculate\n                  console.log(\"Calling calculate_qty_from_database...\");\n                  calculate_qty_from_database(cdn, row);\n              }\n          );\n\n          console.log(\"=== Event binding complete ===\");\n      },\n\n      before_save(frm) {\n          console.log(\"=== before_save fired ===\");\n\n          // Create an array of promises for all async operations\n          let promises = [];\n\n          (frm.doc.items || []).forEach(row => {\n              console.log(\"Processing row:\", row.name, \"Batch:\", row.batch_no);\n\n              // If custom_cone_copy is still missing by save time, set it to current custom_cone\n              if ((!row.custom_cone_copy || row.custom_cone_copy === \"\") && row.custom_cone) {\n                  console.log(\"Setting custom_cone_copy to custom_cone:\", row.custom_cone);\n                  row.custom_cone_copy = row.custom_cone;\n              }\n\n              // Fetch and calculate for each row\n              if (row.batch_no && row.custom_cone && row.custom_cone_copy) {\n                  console.log(\"Fetching batch qty for calculation...\");\n                  let promise = fetch_batch_qty_and_calculate(row.name, row);\n                  promises.push(promise);\n              }\n          });\n\n          // Wait for all calculations to complete before saving\n          if (promises.length > 0) {\n              console.log(\"Waiting for\", promises.length, \"promises to complete...\");\n              frappe.validated = false;\n              Promise.all(promises).then(() => {\n                  console.log(\"All promises completed, saving...\");\n                  frappe.validated = true;\n                  frm.save();\n              });\n          }\n      }\n  });\n\n  /* ------------------------------\n      FETCH BATCH QTY FROM DATABASE AND CALCULATE\n  ------------------------------ */\n  function calculate_qty_from_database(cdn, row) {\n      console.log(\"=== calculate_qty_from_database called ===\");\n      console.log(\"CDN:\", cdn);\n      console.log(\"Row:\", row);\n\n      if (!row || !row.batch_no) {\n          console.log(\"ERROR: No row or batch_no!\");\n          return;\n      }\n\n      console.log(\"Fetching batch_qty for batch:\", row.batch_no);\n\n      // Fetch the batch qty from the database\n      frappe.call({\n          method: \"frappe.client.get_value\",\n          args: {\n              doctype: \"Batch\",\n              filters: { name: row.batch_no },\n              fieldname: \"batch_qty\"\n          },\n          callback: function(r) {\n              console.log(\"=== Batch fetch callback ===\");\n              console.log(\"Response:\", r);\n\n              if (r.message && r.message.batch_qty) {\n                  let database_qty = parseFloat(r.message.batch_qty);\n                  let cone = parseFloat(row.custom_cone);\n                  let cone_copy = parseFloat(row.custom_cone_copy);\n\n                  console.log(\"Database qty:\", database_qty);\n                  console.log(\"Current cone:\", cone);\n                  console.log(\"Cone copy:\", cone_copy);\n\n                  if (isNaN(database_qty) || isNaN(cone) || isNaN(cone_copy)) {\n                      console.log(\"ERROR: NaN values detected!\");\n                      return;\n                  }\n                  if (cone_copy === 0) {\n                      console.log(\"ERROR: cone_copy is zero!\");\n                      return;\n                  }\n\n                  // Calculate new qty using fresh database value\n                  let new_qty = (database_qty * cone) / cone_copy;\n                  console.log(\"Calculated new_qty:\", new_qty);\n                  console.log(\"Formula: (\" + database_qty + \" * \" + cone + \") / \" + cone_copy + \" = \" + new_qty);\n\n                  // Update the qty field\n                  frappe.model.set_value(\"Delivery Note Item\", cdn, \"qty\", flt(new_qty, 3));\n                  console.log(\"Qty updated successfully\");\n              } else {\n                  console.log(\"ERROR: No batch_qty in response!\");\n              }\n          },\n          error: function(err) {\n              console.error(\"ERROR fetching batch qty:\", err);\n          }\n      });\n  }\n\n  /* ------------------------------\n      FETCH BATCH QTY AND CALCULATE (For before_save)\n      Returns a Promise\n  ------------------------------ */\n  function fetch_batch_qty_and_calculate(cdn, row) {\n      console.log(\"=== fetch_batch_qty_and_calculate (Promise version) ===\");\n\n      return new Promise((resolve, reject) => {\n          if (!row || !row.batch_no) {\n              console.log(\"No row or batch_no, resolving...\");\n              resolve();\n              return;\n          }\n\n          console.log(\"Fetching batch_qty for batch:\", row.batch_no);\n\n          frappe.call({\n              method: \"frappe.client.get_value\",\n              args: {\n                  doctype: \"Batch\",\n                  filters: { name: row.batch_no },\n                  fieldname: \"batch_qty\"\n              },\n              callback: function(r) {\n                  console.log(\"Promise callback - Response:\", r);\n\n                  if (r.message && r.message.batch_qty) {\n                      let database_qty = parseFloat(r.message.batch_qty);\n                      let cone = parseFloat(row.custom_cone);\n                      let cone_copy = parseFloat(row.custom_cone_copy);\n\n                      console.log(\"Database qty:\", database_qty);\n                      console.log(\"Current cone:\", cone);\n                      console.log(\"Cone copy:\", cone_copy);\n\n                      if (!isNaN(database_qty) && !isNaN(cone) && !isNaN(cone_copy) && cone_copy !== 0) {\n                          // Calculate new qty using fresh database value\n                          let new_qty = (database_qty * cone) / cone_copy;\n                          console.log(\"Calculated new_qty:\", new_qty);\n\n                          // Update the qty field\n                          frappe.model.set_value(\"Delivery Note Item\", cdn, \"qty\", flt(new_qty, 3));\n                          console.log(\"Qty updated successfully\");\n                      }\n                  }\n                  resolve();\n              },\n              error: function(err) {\n                  console.error(\"ERROR in promise fetch:\", err);\n                  resolve(); // resolve anyway to not block the save\n              }\n          });\n      });\n  }\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Delivery Note",
  "enabled": 1,
  "modified": "2025-12-17 19:33:24.069790",
  "module": "Mhr",
  "name": "Filter cone Greater then 0",
  "script": "frappe.ui.form.on(\"Delivery Note\", {\r\n    onload: function(frm) {\r\n        frm.set_query(\"custom_batch\", function() {\r\n            return {\r\n                filters: [\r\n                    [\"Batch\", \"custom_cone\", \">\", 0]\r\n                ]\r\n            };\r\n        });\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Delivery Note",
  "enabled": 1,
  "modified": "2025-12-17 19:33:24.354736",
  "module": "Mhr",
  "name": "Delivery Note V2",
  "script": "frappe.ui.form.on('Delivery Note', {\n    refresh(frm) {\n        console.log(cur_frm.fields_dict['items'].grid.data.length)\n        cur_frm.set_df_property('scan_barcode', 'hidden',1);\n        frm.set_df_property('currency_and_price_list', 'hidden',1);\n        frm.set_df_property('accounting_dimensions_section', 'hidden',1);\n\n        if (frm.doc.__islocal) {\n            frm.clear_table(\"items\");\n        }\n        \n        // Calculate totals when the form refreshes\n        calculate_totals(frm);\n    },\n    custom_supplier_batch_no: function(frm) {\n        fetch_and_append_batch(frm);\n    },\n    custom_scan_batch_no: function(frm, cdt, cdn) {\n        // Check if the batch already exists in the items table\n        const existingRow = frm.doc.items.find(d => d.batch_no === frm.doc.custom_scan_batch_no);\n        if (existingRow) {\n            // If the batch already exists, notify the user and clear the field\n            frappe.msgprint(__(\"Batch already exists in the table\"));\n            frm.set_value(\"custom_scan_batch_no\", \"\");\n            frm.refresh_field(\"custom_scan_batch_no\");\n        }\n        else {\n            // If the batch does not exist, make a server call to get the batch details\n            frappe.call({\n                method: \"mhr.utilis.get_item_batch\",\n                args: {\n                    batch: frm.doc.custom_scan_batch_no\n                },\n                callback: function(r) {\n                    if (r.message.error) {\n                        // If there is an error in the response, possibly handle it here\n                        return;\n                    }\n                    if (r.message) {\n                        if((r.message.glue).toLowerCase() !== (frm.doc.custom_glue).toLowerCase() ||\n                           (r.message.lusture).toLowerCase() !== (frm.doc.custom_lusture).toLowerCase() ||\n                           (r.message.grade).toLowerCase() !== (frm.doc.custom_grade).toLowerCase() ||\n                           (r.message.pulp).toLowerCase() !== (frm.doc.custom_pulp).toLowerCase() ||\n                           (r.message.fsc).toLowerCase() !== (frm.doc.custom_fsc).toLowerCase()\n                        ) { // Compare the lowercase values\n                            frappe.msgprint(__(\"Parameters are not the same as the value in batch\"));\n                            frm.set_value(\"custom_scan_batch_no\", \"\");\n                            frm.refresh_field(\"custom_scan_batch_no\");\n                        }\n                        else if(frm.doc.custom_cone && (r.message.cone) !== (frm.doc.custom_cone)){\n                            frappe.msgprint(__(\"Parameters are not the same as the value in batch\"));\n                            frm.set_value(\"custom_scan_batch_no\", \"\");\n                            frm.refresh_field(\"custom_scan_batch_no\");\n                        }\n                        else {\n                            frm.add_child(\"items\", {\n                                item_code: r.message.item_code,\n                                item_name: r.message.item_name,\n                                qty: r.message.qty,\n                                batch_no: r.message.batch_no,\n                                uom: r.message.uom,\n                                custom_cone: r.message.cone,\n                                custom_supplier_batch_no: r.message.supplier_batch_no,\n                                custom_container_no: r.message.container_no,\n                                custom_lot_no: r.message.lot_no,\n                                use_serial_batch_fields: 1\n                            });\n                            frm.doc.items.unshift(frm.doc.items.pop());\n                            frm.refresh_field(\"items\");\n                            frm.set_value(\"custom_scan_batch_no\", \"\");\n                            frm.refresh_field(\"custom_scan_batch_no\");\n                            \n                            // Calculate totals after adding a new row\n                            calculate_totals(frm);\n                        }\n                    }\n                }\n            });\n        }\n    }\n});\n\n// Listen for changes in the child table items\nfrappe.ui.form.on('Delivery Note Item', {\n    items_add: function(frm, cdt, cdn) {\n        calculate_totals(frm);\n    },\n    items_remove: function(frm, cdt, cdn) {\n        calculate_totals(frm);\n    },\n    qty: function(frm, cdt, cdn) {\n        calculate_totals(frm);\n    },\n    custom_cone: function(frm, cdt, cdn) {\n        calculate_totals(frm);\n    }\n});\n\n// Function to calculate total cone and total quantity\nfunction calculate_totals(frm) {\n    let total_cone = 0;\n    let total_qty = 0;\n    \n    // Loop through each row in the items child table\n    (frm.doc.items || []).forEach(function(row) {\n        // Add the cone value of each row to total_cone\n        total_cone += parseFloat(row.custom_cone || 0);\n        \n        // Add the qty value of each row to total_qty\n        total_qty += parseFloat(row.qty || 0);\n    });\n    \n    // Set the total cone and total qty in the main document\n    frm.set_value('custom_total_cone', total_cone);\n    frm.set_value('total_qty', total_qty);\n    \n    // Refresh the fields to show the updated values\n    frm.refresh_field('custom_total_cone');\n    frm.refresh_field('total_qty');\n}\n\nfunction fetch_and_append_batch(frm) {\n    // Ensure both fields have values before making the call\n    if (frm.doc.custom_supplier_batch_no && frm.doc.custom_container_no && frm.doc.custom_lot_no) {\n        frappe.call({\n            method: \"mhr.utilis.get_delivery_note_batch\",\n            args: {\n                lot_no: frm.doc.custom_lot_no,\n                container_no: frm.doc.custom_container_no,\n                supplier_batch_no: frm.doc.custom_supplier_batch_no,\n                glue: frm.doc.custom_glue,\n                pulp: frm.doc.custom_pulp,\n                fsc: frm.doc.custom_fsc,\n                lusture: frm.doc.custom_lusture,\n                grade: frm.doc.custom_grade,\n                cone: frm.doc.custom_cone,\n                denier: frm.doc.custom_denier\n            },\n            callback: function(response) {\n                if (response.message) {\n                    var data = response.message;\n\n                    // Check if the batch already exists in the child table\n                    var exists = frm.doc.items.some(function(row) {\n                        return row.batch_no === data.batch_no;  // Correct field name: 'batch_no'\n                    });\n\n                    if (!exists) {\n                        // Add a new row to the table with the correct field names\n                        let new_row = frm.add_child(\"items\", {\n                            item_code: data.item_code,\n                            item_name: data.item_name,\n                            qty: data.qty,\n                            batch_no: data.batch_no,  // Correct field name\n                            uom: data.uom,\n                            custom_cone: data.cone,\n                            custom_supplier_batch_no: data.supplier_batch_no,\n                            custom_container_no: data.container_no,\n                            custom_lot_no: data.lot_no,\n                            use_serial_batch_fields: 1\n                        });\n\n                        frm.doc.items.unshift(frm.doc.items.pop());  // Reorder the table if needed\n                        frm.refresh_field(\"items\");\n                        frm.set_value(\"custom_supplier_batch_no\", \"\");\n                        frm.refresh_field(\"custom_supplier_batch_no\");\n                        \n                        // Calculate totals after adding a new row\n                        calculate_totals(frm);\n                    } else {\n                        frappe.msgprint(__('Batch already exists in the list.'));\n                    }\n                }\n            }\n        });\n    }\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Delivery Note",
  "enabled": 0,
  "modified": "2025-12-17 19:33:24.328920",
  "module": "Mhr",
  "name": "Delivery Note",
  "script": "frappe.ui.form.on('Delivery Note', {\n    refresh(frm) {\n        console.log(cur_frm.fields_dict['items'].grid.data.length)\n        cur_frm.set_df_property('scan_barcode', 'hidden',1);\n        frm.set_df_property('currency_and_price_list', 'hidden',1);\n        frm.set_df_property('accounting_dimensions_section', 'hidden',1);\n\n        if (frm.doc.__islocal) {\n            frm.clear_table(\"items\");\n        }\n    },\n    custom_supplier_batch_no: function(frm){\n        fetch_and_append_batch(frm);\n        \n    },\n    custom_scan_batch_no: function(frm, cdt, cdn) {\n      \n       \n        // Check if the batch already exists in the items table\n        const existingRow = frm.doc.items.find(d => d.batch_no === frm.doc.custom_scan_batch_no);\n        if (existingRow) {\n            // If the batch already exists, notify the user and clear the field\n            frappe.msgprint(__(\"Batch already exists in the table\"));\n            frm.set_value(\"custom_scan_batch_no\", \"\");\n            frm.refresh_field(\"custom_scan_batch_no\");\n        }\n        else {\n            \n            // If the batch does not exist, make a server call to get the batch details\n            frappe.call({\n                method: \"mhr.utilis.get_item_batch\",\n                args: {\n                    batch:frm.doc.custom_scan_batch_no\n                },\n                callback: function(r) {\n                    if (r.message.error) {\n                        // If there is an error in the response, possibly handle it here\n                        return;\n                    }\n                    if (r.message) {\n                        \n                     if((r.message.glue).toLowerCase() !== (frm.doc.custom_glue).toLowerCase() ||\n                        (r.message.lusture).toLowerCase() !== (frm.doc.custom_lusture).toLowerCase() ||\n                        (r.message.grade).toLowerCase() !== (frm.doc.custom_grade).toLowerCase() ||\n                        (r.message.pulp).toLowerCase() !== (frm.doc.custom_pulp).toLowerCase() ||\n                        (r.message.fsc).toLowerCase() !== (frm.doc.custom_fsc).toLowerCase()\n                         ) { // Compare the lowercase values\n                            frappe.msgprint(__(\"Parameters are not the same as the value in batch\"));\n                            frm.set_value(\"custom_scan_batch_no\", \"\");\n                            frm.refresh_field(\"custom_scan_batch_no\");\n                        }\n                        else if(frm.doc.custom_cone && (r.message.cone) !== (frm.doc.custom_cone)){\n                             frappe.msgprint(__(\"Parameters are not the same as the value in batch\"));\n                            frm.set_value(\"custom_scan_batch_no\", \"\");\n                            frm.refresh_field(\"custom_scan_batch_no\");\n                        }\n                        else {\n                        frm.add_child(\"items\", {\n                            item_code: r.message.item_code,\n                            item_name: r.message.item_name,\n                            qty: r.message.qty,\n                            batch_no: r.message.batch_no,\n                            uom: r.message.uom,\n                            custom_cone: r.message.cone,\n                            custom_supplier_batch_no:r.message.supplier_batch_no,\n                            custom_container_no: r.message.container_no,\n                            custom_lot_no: r.message.lot_no,\n                            use_serial_batch_fields: 1\n                        });\n                        frm.doc.items.unshift(frm.doc.items.pop());\n                        frm.refresh_field(\"items\");\n                        frm.set_value(\"custom_scan_batch_no\", \"\");\n                        frm.refresh_field(\"custom_scan_batch_no\");\n                    }\n                    }\n                }\n            });\n        }\n        }\n    \n});\n\nfunction fetch_and_append_batch(frm) {\n    // Ensure both fields have values before making the call\n    if (frm.doc.custom_supplier_batch_no && frm.doc.custom_container_no && frm.doc.custom_lot_no) {\n        frappe.call({\n            method: \"mhr.utilis.get_delivery_note_batch\",\n            args: {\n                lot_no: frm.doc.custom_lot_no,\n                container_no: frm.doc.custom_container_no,\n                supplier_batch_no: frm.doc.custom_supplier_batch_no,\n                glue:frm.doc.custom_glue,\n                pulp:frm.doc.custom_pulp,\n                fsc:frm.doc.custom_fsc,\n                lusture: frm.doc.custom_lusture,\n                grade: frm.doc.custom_grade,\n                cone: frm.doc.custom_cone,\n                denier: frm.doc.custom_denier\n            },\n            callback: function(response) {\n                if (response.message) {\n                    var data = response.message;\n\n                    // Check if the batch already exists in the child table\n                    var exists = frm.doc.items.some(function(row) {\n                        return row.batch_no === data.batch_no;  // Correct field name: 'batch_no'\n                    });\n\n                    if (!exists) {\n                        // Add a new row to the table with the correct field names\n                        let new_row = frm.add_child(\"items\", {\n                            item_code: data.item_code,\n                            item_name: data.item_name,\n                            qty: data.qty,\n                            batch_no: data.batch_no,  // Correct field name\n                            uom: data.uom,\n                            custom_cone: data.cone,\n                            custom_supplier_batch_no: data.supplier_batch_no,\n                            custom_container_no: data.container_no,\n                            custom_lot_no: data.lot_no,\n                            use_serial_batch_fields: 1\n                        });\n\n                        frm.doc.items.unshift(frm.doc.items.pop());  // Reorder the table if needed\n                        frm.refresh_field(\"items\");\n                        frm.set_value(\"custom_supplier_batch_no\", \"\");\n                        frm.refresh_field(\"custom_supplier_batch_no\");\n                    } else {\n                        frappe.msgprint(__('Batch already exists in the list.'));\n                    }\n                }\n            }\n        });\n        \n    }\n}\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Receipt",
  "enabled": 1,
  "modified": "2025-12-17 19:33:24.515488",
  "module": "Mhr",
  "name": "Lot No",
  "script": "frappe.ui.form.on('Purchase Receipt', {\n    refresh(frm) {\n        \n    },\n    //get batche if lot no is filled\n    custom_container_no: function(frm) {\n        itemShow = []\n            frappe.call({\n                method: \"mhr.utilis.get_lot_nos\",\n                args: {\n                    \"container_no\": frm.doc.custom_container_no\n                },\n                callback: function(r) {\n                    if(r.message){\n                        //set the  th eoptions fo rlot not\n                        frm.set_df_property('custom_lot_number', 'options', [r.message]);       \n                    }\n                }\n            });\n        \n    },\n    //get the lot no if container no is filled\n    custom_lot_number: function(frm) {\n        if(frm.doc.custom_container_no){\n            frappe.call({\n                method: \"mhr.utilis.get_batches\",\n                args: {\n                    \"container_no\": frm.doc.custom_container_no,\n                    \"lot_no\": frm.doc.custom_lot_number\n                },\n                callback: function(r) {\n                    if(r.message){\n                      //append the items to the table\n                        console.log(r.message);\n                        frm.doc.items = []\n                        $.each(r.message, function(i, d) {\n                            var item = {\n                                item_code: d.item,\n                                item_name: d.item,\n                                qty: d.batch_qty,\n                                rate: d.rate,\n                                amount: d.amount,\n                                uom: d.stock_uom,\n                                rate:200,\n                                price_list_rate:200,\n                                use_serial_batch_fields:1,\n                                batch_no: d.name,\n                                warehouse: \"Finished Goods - MC\",\n\n                                \n                            }\n                            frm.add_child(\"items\", item);\n                        });\n                        frm.refresh_field(\"items\");\n                }\n            }\n            \n            });\n        }\n    },\n    //a function to append the item to the table\n    \n  \n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Batch",
  "enabled": 1,
  "modified": "2025-12-17 19:33:24.432610",
  "module": "Mhr",
  "name": "Unfreeze Field in batch",
  "script": "frappe.ui.form.on('Batch', {\n\trefresh(frm) {\n\t    frm.set_df_property(\"custom_container_no\", \"read_only\", 0)\n\t\t// your code here\n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Stock Entry",
  "enabled": 1,
  "modified": "2025-12-17 19:33:24.379373",
  "module": "Mhr",
  "name": "Stock entry",
  "script": "frappe.ui.form.on('Stock Entry', {\n\trefresh(frm) {\n\t\t// your code here\n\t},\n\n    custom_supplier_batch_no: function(frm) {\n        fetch_and_append_batch(frm);\n    },\n\n    custom_lot_no: function(frm) {\n        fetch_and_append_batch(frm);\n    }\n});\n\nfunction fetch_and_append_batch(frm) {\n    // Ensure both fields have values before making the call\n    if (frm.doc.custom_supplier_batch_no) {\n        frappe.call({\n            method: \"mhr.utilis.get_print_batch\",\n            args: {\n                lot_no: frm.doc.custom_lot_no,\n                container_no: frm.doc.custom_container_number,\n                supplier_batch_no: frm.doc.custom_supplier_batch_no,\n            },\n            callback: function(response) {\n                if (response.message) {\n                    console.log(response.message);\n                    var data = response.message;\n\n                    // Check if the batch already exists in the child table\n                    var exists = frm.doc.items.some(function(row) {\n                        return row.batch_no === data.batch;\n                    });\n\n                    if (!exists) {\n                        // Add a new row to the table\n                        var childTable = frm.add_child(\"items\");\n                        childTable.item_code = data.item\n                        childTable.batch_no = data.batch;\n                        childTable.custom_cone = data.cone;\n                        // childTable.batch_qty = data.batch_qty;\n                        \n                        // Move the newly added row to the top of the table\n                        // frm.doc.list_batches.unshift(frm.doc.list_batches.pop());\n                        \n                        frm.refresh_field(\"items\");\n                        frm.set_value(\"custom_supplier_batch_no\", \"\");  \n                    } else {\n                        frappe.msgprint(__('Batch already exists in the list.'));\n                    }\n                }\n            }\n        });\n    }\n}\n\n// frappe.ui.form.on('List Batches', {\n//     batch: function(frm, cdt, cdn) {\n//         var child = locals[cdt][cdn];\n//         // Check if the batch already exists in the child table\n//         var exists = frm.doc.items.some(function(row) {\n//             return row.batch === child.batch && row.name !== child.name;\n//         });\n\n//         if (exists) {\n//             frappe.msgprint(__('Batch already exists in the list.'));\n//             frappe.model.set_value(cdt, cdn, 'batch', '');\n//         }\n//     }\n// });\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Email Account",
  "enabled": 1,
  "modified": "2025-12-17 19:33:24.228685",
  "module": "Mhr",
  "name": "Email account won't work warning",
  "script": "frappe.ui.form.on('Email Account', {\n\trefresh(frm) {\n// \t\tif (frm.doc.enable_outgoing) {\n\t\t\tsite_name = window.location.hostname;\n\t\t\tuninstall_link = `https://cloud.frappe.io/dashboard/sites/${site_name}/apps`;\n\t\t\teds_a_tag = `<a style='text-decoration: underline;' href='https://cloud.frappe.io/marketplace/apps/email_delivery_service'>Email Delivery Service</a>`;\n\t\t\t//make a head request to /api/method/ping and check if response has server header set as 'Frappe Cloud'\n\t\t\tis_frappe_cloud = fetch('/api/method/ping', { method: 'HEAD' }).then(\n\t\t\t\t(response) => {\n\t\t\t\t\tif (response.headers.get('server') === 'Frappe Cloud') {\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t);\n\t\t\tuninstall_a_tag = `<a style='text-decoration: underline;' href='${uninstall_link}'>uninstall the app</a>`;\n\t\t\tif (!is_frappe_cloud) {\n\t\t\t\tuninstall_a_tag = 'uninstall the app';\n\t\t\t}\n\t\t\tfrm.dashboard.set_headline_alert(\n\t\t\t\t__(\n\t\t\t\t\t`You have ${eds_a_tag} app installed due to which emails won't be sent from this account. Please ${uninstall_a_tag} to use current Email Account for sending.`,\n\t\t\t\t),\n\t\t\t\t'yellow',\n\t\t\t);\n// \t\t}\n\t},\n});\n",
  "view": "Form"
 }
]